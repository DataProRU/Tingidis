{% extends 'base.html' %}

{% block title %}Добро пожаловать{% endblock %}

{% block nav %}
<div class="welcome-container">
    <h2 class="welcome-title">Сотрудники</h2>
</div>
<div class="time-container">
    <div class="add-employee-button" id="add-employee-button">+</div>
</div>
{% endblock %}

{% block content %}
<div class="employee-table-container">
    <table class="employee-table">
        <thead>
            <tr>
                <th>Фамилия</th>
                <th>Имя</th>
                <th>Отчество</th>
                <th>Фамилия ИО</th>
                <th>Должность</th>
                <th>Телефон</th>
                <th>e-mail</th>
                <th>Логин Телеграм</th>
                <th>ДР, дата</th>
                <th>Категория</th>
                <th>Специализация</th>
                <th>Примечание</th>
                <th>Логин</th>
                <th>Роль</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.last_name }}</td>
                <td>{{ user.first_name }}</td>
                <td>{{ user.middle_name }}</td>
                <td>{{ user.full_name }}</td>
                <td>{{ user.position }}</td>
                <td>{{ user.phone }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.telegram }}</td>
                <td>{{ user.birthdate }}</td>
                <td>{{ user.category }}</td>
                <td>{{ user.specialization }}</td>
                <td>{{ user.notes }}</td>
                <td>{{ user.login }}</td>
                <td>{{ user.role }}</td>
                <td>
                    <button class="edit-button" data-user-id="{{ user.id }}">Изменить</button>
                    <button class="delete-button" data-user-id="{{ user.id }}">Удалить</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Всплывающее окно для добавления нового сотрудника -->
<div id="add-employee-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-modal">&times;</span>
        <h2>Добавить нового сотрудника</h2>
        <form action="/users/add/" method="post">
            <div class="form-group flex">
                <div class="form-item">
                    <label for="last-name">Фамилия:</label>
                    <input type="text" id="last-name" name="last_name" required>
                </div>
                <div class="form-item">
                    <label for="first-name">Имя:</label>
                    <input type="text" id="first-name" name="first_name" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="middle-name">Отчество:</label>
                    <input type="text" id="middle-name" name="middle_name" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="position">Должность:</label>
                    <input type="text" id="position" name="position" required>
                </div>
                <div class="form-item">
                    <label for="phone">Телефон:</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="email">e-mail:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-item">
                    <label for="telegram">Логин Телеграм:</label>
                    <input type="text" id="telegram" name="telegram" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="birthdate">ДР, дата:</label>
                    <input type="date" id="birthdate" name="birthdate" required>
                </div>
                <div class="form-item">
                    <label for="category">Категория:</label>
                    <input type="text" id="category" name="category" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="specialization">Специализация:</label>
                    <input type="text" id="specialization" name="specialization" required>
                </div>
                <div class="form-item">
                    <label for="notes">Примечание:</label>
                    <input type="text" id="notes" name="notes" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="login">Логин:</label>
                    <input type="text" id="login" name="login" required>
                </div>
                <div class="form-item">
                    <label for="password">Пароль:</label>
                    <input type="password" id="password" name="password" required>
                    <div id="password-strength-indicator" class="password-strength-indicator">
                        <span class="strength-bar" id="strength-bar-1"></span>
                        <span class="strength-bar" id="strength-bar-2"></span>
                        <span class="strength-bar" id="strength-bar-3"></span>
                        <span class="strength-bar" id="strength-bar-4"></span>
                        <span class="strength-bar" id="strength-bar-5"></span>
                    </div>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="role">Роль:</label>
                    <select id="role" name="role" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <input type="submit" value="Добавить">
            </div>
        </form>
    </div>
</div>

<div id="edit-employee-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-edit-modal">&times;</span>
        <h2>Редактировать сотрудника</h2>
        <form id="edit-employee-form" method="post">
            <input type="hidden" id="edit-user-id" name="user_id">
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-last-name">Фамилия:</label>
                    <input type="text" id="edit-last-name" name="last_name" required>
                </div>
                <div class="form-item">
                    <label for="edit-first-name">Имя:</label>
                    <input type="text" id="edit-first-name" name="first_name" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-middle-name">Отчество:</label>
                    <input type="text" id="edit-middle-name" name="middle_name" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-position">Должность:</label>
                    <input type="text" id="edit-position" name="position" required>
                </div>
                <div class="form-item">
                    <label for="edit-phone">Телефон:</label>
                    <input type="tel" id="edit-phone" name="phone" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-email">e-mail:</label>
                    <input type="email" id="edit-email" name="email" required>
                </div>
                <div class="form-item">
                    <label for="edit-telegram">Логин Телеграм:</label>
                    <input type="text" id="edit-telegram" name="telegram" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-birthdate">ДР, дата:</label>
                    <input type="date" id="edit-birthdate" name="birthdate" required>
                </div>
                <div class="form-item">
                    <label for="edit-category">Категория:</label>
                    <input type="text" id="edit-category" name="category" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-specialization">Специализация:</label>
                    <input type="text" id="edit-specialization" name="specialization" required>
                </div>
                <div class="form-item">
                    <label for="edit-notes">Примечание:</label>
                    <input type="text" id="edit-notes" name="notes" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-login">Логин:</label>
                    <input type="text" id="edit-login" name="login" required>
                </div>
                <div class="form-item">
                    <label for="edit-password">Пароль:</label>
                    <input type="password" id="edit-password" name="password" required>
                    <div id="edit-password-strength-indicator" class="password-strength-indicator">
                        <span class="strength-bar" id="edit-strength-bar-1"></span>
                        <span class="strength-bar" id="edit-strength-bar-2"></span>
                        <span class="strength-bar" id="edit-strength-bar-3"></span>
                        <span class="strength-bar" id="edit-strength-bar-4"></span>
                        <span class="strength-bar" id="edit-strength-bar-5"></span>
                    </div>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-role">Роль:</label>
                    <select id="edit-role" name="role" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <input type="submit" value="Сохранить">
            </div>
        </form>
    </div>
</div>

<style>
      body {
            background-image: url("/static/uploads/{{ bg_filename }}");
            }
.employee-table-container {
    margin: 20px auto;
    max-width: 100%;
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow-x: auto; /* Добавляем горизонтальную прокрутку */
}

.employee-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto; /* Изменяем на auto для адаптивности */
}

.employee-table th,
.employee-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
    font-size: 14px;
    white-space: nowrap; /* Предотвращаем перенос текста */
}

.employee-table th {
    background-color: #00aaff; /* Изменяем цвет фона */
    color: white; /* Изменяем цвет текста */
    font-weight: bold;
    text-transform: uppercase;
}

.employee-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.section-center {
    display: block; /* Отменяем центровку */
    padding: 20px; /* Добавляем отступ для удобства чтения */
}

.add-employee-button {
    width: 50px;
    height: 50px;
    background-color: #00aaff;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
}

/* Стили для всплывающего окна */
.modal {
    display: none; /* Скрываем модальное окно по умолчанию */
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
    padding-top: 60px;
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    position: relative;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close-button:hover,
.close-button:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

.modal-content h2 {
    margin-top: 0;
    color: #00aaff;
}

.form-group {
    margin-bottom: 15px;
}

.form-group.flex {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.form-item {
    flex: 1;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

.form-group input[type="text"],
.form-group input[type="email"],
.form-group input[type="password"],
.form-group input[type="date"],
.form-group input[type="number"],
.form-group input[type="tel"],
.form-group select {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
}

.form-group select {
    background-color: #f9f9f9;
    cursor: pointer;
    appearance: none; /* Убираем стандартное оформление селектора */
    -webkit-appearance: none; /* Для WebKit браузеров */
    -moz-appearance: none; /* Для Firefox */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 144"><path fill="%23333" d="M43.018 96.5l55.512-55.512a6.997 6.997 0 0 0-9.9-9.9L33.118 86.6a7.002 7.002 0 0 0 0 9.9l55.512 55.512a6.997 6.997 0 1 0 9.9-9.9L43.018 96.5z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 12px;
    padding-right: 30px; /* Добавляем отступ справа для иконки */
}

.form-group input[type="submit"] {
    background-color: #00aaff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
}

.form-group input[type="submit"]:hover {
    background-color: #0088cc;
}

.edit-button,
.delete-button {
    background-color: #00aaff;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 5px 10px;
    cursor: pointer;
    margin: 2px;
}

.edit-button:hover,
.delete-button:hover {
    background-color: #0088cc;
}

.password-strength-indicator {
    display: flex;
    align-items: center;
    margin-top: 5px;
}

.strength-bar {
    width: 20px;
    height: 5px;
    background-color: #ddd;
    margin-right: 2px;
    border-radius: 3px;
}

.strength-bar.active {
    background-color: #00aaff;
}
</style>

<script>
function clearFormFields() {
    document.getElementById('last-name').value = '';
    document.getElementById('first-name').value = '';
    document.getElementById('middle-name').value = '';
    document.getElementById('position').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('email').value = '';
    document.getElementById('telegram').value = '';
    document.getElementById('birthdate').value = '';
    document.getElementById('category').value = '';
    document.getElementById('specialization').value = '';
    document.getElementById('notes').value = '';
    document.getElementById('login').value = '';
    document.getElementById('password').value = '';
    document.getElementById('role').value = 'user';
}

document.getElementById('add-employee-button').addEventListener('click', function() {
    clearFormFields();
    document.getElementById('add-employee-modal').style.display = 'block';
});

document.getElementById('close-modal').addEventListener('click', function() {
    document.getElementById('add-employee-modal').style.display = 'none';
});

document.getElementById('close-edit-modal').addEventListener('click', function() {
    document.getElementById('edit-employee-modal').style.display = 'none';
});

window.addEventListener('click', function(event) {
    var modal = document.getElementById('add-employee-modal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }

    var editModal = document.getElementById('edit-employee-modal');
    if (event.target == editModal) {
        editModal.style.display = 'none';
    }
});

document.querySelectorAll('.edit-button').forEach(button => {
    button.addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        fetch(`/users/${userId}/`)
            .then(response => response.json())
            .then(user => {
                if (user.detail) {
                    alert(user.detail);
                    return;
                }
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-last-name').value = user.last_name;
                document.getElementById('edit-first-name').value = user.first_name;
                document.getElementById('edit-middle-name').value = user.middle_name;
                document.getElementById('edit-position').value = user.position;
                document.getElementById('edit-phone').value = user.phone;
                document.getElementById('edit-email').value = user.email;
                document.getElementById('edit-telegram').value = user.telegram;
                document.getElementById('edit-birthdate').value = user.birthdate;
                document.getElementById('edit-category').value = user.category;
                document.getElementById('edit-specialization').value = user.specialization;
                document.getElementById('edit-notes').value = user.notes;
                document.getElementById('edit-login').value = user.login;
                document.getElementById('edit-password').value = '';
                document.getElementById('edit-role').value = user.role;
                document.getElementById('edit-employee-modal').style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
                alert(`Ошибка: ${error.message}`)
            });
    });
});

document.getElementById('edit-employee-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const userId = document.getElementById('edit-user-id').value;
    const formData = new FormData(this);
    fetch(`/users/${userId}/edit/`, {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            return response.json().then(data => {
                throw new Error(JSON.stringify(data));
            });
        }
    }).catch(error => {
        console.error('Error:', error);
        alert(`Ошибка: ${error.message}`);
    });
});

document.querySelectorAll('.delete-button').forEach(button => {
    button.addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        if (confirm('Вы уверены, что хотите удалить этого сотрудника?')) {
            fetch(`/users/${userId}/delete/`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Ошибка при удалении сотрудника');
                }
            });
        }
    });
});

// Функция для форматирования номера телефона
function formatPhoneNumber(input) {
    let value = input.value.replace(/\D/g, ''); // Удаляем все нецифровые символы
    if (value.startsWith('8')) {
        value = '7' + value.substring(1); // Заменяем 8 на 7
    }
    if (value.startsWith('7')) {
        value = '+7 (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + ' ' + value.substring(7, 10) + ' ' + value.substring(10); // Форматируем номер
    }
    input.value = value;
}

// Добавляем обработчик события input для полей ввода телефона
document.getElementById('phone').addEventListener('input', function(event) {
    const input = event.target;
    let rawValue = input.value.replace(/\D/g, ''); // Удаляем все символы, кроме цифр

    // Убедимся, что номер начинается с "7" (для России)
    if (!rawValue.startsWith('7')) {
        rawValue = '7' + rawValue;
    }

    // Форматируем номер телефона
    const formattedValue = rawValue.replace(/^7(\d{3})(\d{3})(\d{2})(\d{2})$/, '+7 ($1) $2-$3-$4');

    // Ограничиваем ввод только до нужного количества символов
    if (rawValue.length <= 11) {
        input.value = formattedValue;
    } else {
        input.value = input.value.slice(0, 18);
    }
});

document.getElementById('edit-phone').addEventListener('input', function(event) {
    const input = event.target;
    let rawValue = input.value.replace(/\D/g, '');

    if (!rawValue.startsWith('7')) {
        rawValue = '7' + rawValue;
    }

    const formattedValue = rawValue.replace(/^7(\d{3})(\d{3})(\d{2})(\d{2})$/, '+7 ($1) $2-$3-$4');

    if (rawValue.length <= 11) {
        input.value = formattedValue;
    } else {
        input.value = input.value.slice(0, 18);
    }
});

// Функция для оценки силы пароля
function checkPasswordStrength(password) {
    let strength = 0;
    if (password.length >= 8) strength++;
    if (password.match(/[A-Z]/)) strength++;
    if (password.match(/[a-z]/)) strength++;
    if (password.match(/[0-9]/)) strength++;
    if (password.match(/[\W_]/)) strength++;

    return strength;
}

// Функция для обновления индикатора силы пароля
function updatePasswordStrengthIndicator(strength) {
    const bars = document.querySelectorAll('.strength-bar');
    bars.forEach((bar, index) => {
        if (index < strength) {
            bar.classList.add('active');
        } else {
            bar.classList.remove('active');
        }
    });
}

// Обработчик события для обновления индикатора силы пароля при вводе
document.getElementById('password').addEventListener('input', function(event) {
    const password = event.target.value;
    const strength = checkPasswordStrength(password);
    updatePasswordStrengthIndicator(strength);
});

// Обработчик события для обновления индикатора силы пароля при вводе в форме редактирования
document.getElementById('edit-password').addEventListener('input', function(event) {
    const password = event.target.value;
    const strength = checkPasswordStrength(password);
    updatePasswordStrengthIndicator(strength);
});

// Обработчик события для проверки пароля перед отправкой формы
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(event) {
        const passwordInput = form.querySelector('input[name="password"]');
        if (passwordInput) {
            const password = passwordInput.value;
            const strength = checkPasswordStrength(password);
            if (strength < 3) {
                event.preventDefault();
                alert('Пароль слишком слабый. Пожалуйста, используйте более сложный пароль.');
            }
        }
    });
});
</script>
{% endblock %}
