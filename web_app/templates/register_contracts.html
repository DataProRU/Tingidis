{% extends 'base.html' %}

{% block title %}Добро пожаловать{% endblock %}

{% block nav %}
<div class="welcome-container">
    <h2 class="welcome-title">Реестр договоров</h2>
</div>
<div class="time-container">
    <div class="add-contract-button" id="add-contract-button">+</div>
</div>
{% endblock %}

{% block content %}
<div class="contract-table-container">
    <table class="contract-table">
        <thead>
            <tr>
                <th>Шифр объекта</th>
                <th>Наименование объекта</th>
                <th>Заказчик</th>
                <th>Исполнитель</th>
                <th>Номер договора</th>
                <th>Статус</th>
                <th>Стадия</th>
                <th>Скан подписанного договора</th>
                <th>Оригинал подписанного договора</th>
                <th>% выполнения</th>
                <th>Дата подписания договора</th>
                <th>Дата окончания договора</th>
                <th>Стоимость договора</th>
                <th>Получено</th>
                <th>Остаток</th>
                <th>Скан подписанного акта выполненных работ</th>
                <th>Оригинал подписанного акта выполненных работ</th>
                <th>Объемы</th>
                <th>Примечания</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for contract in contracts %}
            <tr>
                <td>{{ contract.contract_code }}</td>
                <td>{{ contract.object_name }}</td>
                <td>{{ contract.customer }}</td>
                <td>{{ contract.executer }}</td>
                <td>{{ contract.contract_number }}</td>
                <td>{{ contract.status }}</td>
                <td>{{ contract.stage }}</td>
                <td>{{ contract.contract_scan }}</td>
                <td>{{ contract.original_scan }}</td>
                <td>{{ contract.percent_complite }}</td>
                <td>{{ contract.date_start }}</td>
                <td>{{ contract.date_finish }}</td>
                <td>{{ contract.cost }}</td>
                <td>{{ contract.money_received}}</td>
                <td>{{ contract.money_left}}</td>
                <td>{{ contract.scan_complited_act}}</td>
                <td>{{ contract.original_complited_act}}</td>
                <td>{{ contract.volumes}}</td>
                <td>{{ contract.notes}}</td>
                <td>
                    <button class="edit-button" data-contract-id="{{ contract.id }}">Изменить</button>
                    <button class="delete-button" data-contract-id="{{ contract.id }}">Удалить</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Всплывающее окно для добавления нового договора -->
<div id="add-contract-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-modal">&times;</span>
        <h2>Зарегистрировать новый договор</h2>
        <form action="/register_contracts/add/" method="post">
            <div class="form-group flex">
                <div class="form-item">
                    <label for="contract-code">Шифр объекта:</label>
                    <input type="text" id="contract-code" name="contract_code" required>
                </div>
                <div class="form-item">
                    <label for="object-name">Наименование объекта:</label>
                    <input type="text" id="object-name" name="object_name" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="customer">Заказчик:</label>
                    <input type="text" id="customer" name="customer" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="executer">Исполнитель:</label>
                    <input type="text" id="executer" name="executer" required>
                </div>
                <div class="form-item">
                    <label for="contract-number">Номер договора</label>
                    <input type="text" id="contract-number" name="contract_number" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="status">Статус:</label>
                    <input type="text" id="status" name="status" required>
                </div>
                <div class="form-item">
                    <label for="stage">Стадия:</label>
                    <input type="text" id="stage" name="stage" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="contract-scan">Скан подписанного договора:</label>
                    <input type="text" id="contract-scan" name="contract_scan" required>
                </div>
                <div class="form-item">
                    <label for="original-scan">Оригинал подписанного договора:</label>
                    <input type="text" id="original-scan" name="original_scan" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="percent-complite">% выполнения:</label>
                    <input type="text" id="percent-complite" name="percent_complite" required>
                </div>
                <div class="form-item">
                    <label for="date-start">Дата подписания договора:</label>
                    <input type="date" id="date-start" name="date_start" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="date-finish">Дата окончания договора:</label>
                    <input type="text" id="date-finish" name="date_finish" required>
                </div>
                <div class="form-item">
                    <label for="cost">Стоимость договора:</label>
                    <input type="text" id="cost" name="cost" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="money-received">Получено:</label>
                    <input type="text" id="money-received" name="money_received" required>
                </div>
                <div class="form-item">
                    <label for="money-left">Остаток:</label>
                    <input type="text" id="money-left" name="money_left" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="scan-complited-act">Скан подписанного акта выполненных работ:</label>
                    <input type="text" id="scan-complited-act" name="scan_complited_act" required>
                </div>
                <div class="form-item">
                    <label for="original-complited-act">Оригинал подписанного акта выполненных работ:</label>
                    <input type="text" id="original-complited-act" name="original_complited_act" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="volumes">Объемы:</label>
                    <input type="text" id="volumes" name="volumes" required>
                </div>
                <div class="form-item">
                    <label for="notes">Примечания:</label>
                    <input type="text" id="notes" name="notes" required>
                </div>
            </div>
            <div class="form-group">
                <input type="submit" value="Добавить">
            </div>
        </form>
    </div>
</div>

<div id="edit-contract-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-edit-modal">&times;</span>
        <h2>Редактировать договор</h2>
        <form id="edit-contract-form" method="post">
            <input type="hidden" id="edit-contract-id" name="contract_id">
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-contract-code">Шифр объекта:</label>
                    <input type="text" id="edit-contract-code" name="contract_code" required>
                </div>
                <div class="form-item">
                    <label for="edit-object-name">Наименование объекта:</label>
                    <input type="text" id="edit-object-name" name="object_name" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-customer">Заказчик:</label>
                    <input type="text" id="edit-customer" name="customer" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-executer">Исполнитель:</label>
                    <input type="text" id="edit-executer" name="executer" required>
                </div>
                <div class="form-item">
                    <label for="edit-contract-number">Номер договора:</label>
                    <input type="text" id="edit-contract-number" name="contract_number" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-status">Статус:</label>
                    <input type="text" id="edit-status" name="status" required>
                </div>
                <div class="form-item">
                    <label for="edit-stage">Стадия:</label>
                    <input type="text" id="edit-stage" name="stage" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-contract-scan">Скан подписанного договора:</label>
                    <input type="text" id="edit-contract-scan" name="contract_scan" required>
                </div>
                <div class="form-item">
                    <label for="edit-original-scan">Оригинал подписанного договора:</label>
                    <input type="text" id="edit-original-scan" name="original_scan" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-percent-complite">% выполнения:</label>
                    <input type="text" id="edit-percent-complite" name="percent_complite" required>
                </div>
                <div class="form-item">
                    <label for="edit-date-start">Дата подписания договора:</label>
                    <input type="date" id="edit-date-start" name="date_start" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-date-finish">Дата окончания договора:</label>
                    <input type="text" id="edit-date-finish" name="date_finish" required>
                </div>
                <div class="form-item">
                    <label for="edit-cost">Стоимость договора:</label>
                    <input type="text" id="edit-cost" name="cost" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-money-received">Получено:</label>
                    <input type="text" id="edit-money-received" name="money_received" required>
                </div>
                <div class="form-item">
                    <label for="edit-money-left">Остаток:</label>
                    <input type="text" id="edit-money-left" name="money_left" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-scan-complited-act">Скан подписанного акта выполненных работ:</label>
                    <input type="text" id="edit-scan-complited-act" name="scan_complited_act" required>
                </div>
                <div class="form-item">
                    <label for="edit-original-complited-act">Оригинал подписанного акта выполненных работ:</label>
                    <input type="text" id="edit-original-complited-act" name="original_complited_act" required>
                </div>
            </div>
            <div class="form-group flex">
                <div class="form-item">
                    <label for="edit-volumes">Объемы:</label>
                    <input type="text" id="edit-volumes" name="volumes" required>
                </div>
                <div class="form-item">
                    <label for="edit-notes">Примечания:</label>
                    <input type="text" id="edit-notes" name="notes" required>
                </div>
            </div>
            <div class="form-group">
                <input type="submit" value="Сохранить">
            </div>
        </form>
    </div>
</div>

<style>
    body {
        background-image: url("/static/uploads/{{ bg_filename }}");
    }

    .contract-table-container {
        margin: 20px auto;
        max-width: 100%;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
        /* Добавляем горизонтальную прокрутку */
    }

    .contract-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: auto;
        /* Изменяем на auto для адаптивности */
    }

    .contract-table th,
    .contract-table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
        font-size: 14px;
        white-space: nowrap;
        /* Предотвращаем перенос текста */
    }

    .contract-table th {
        background-color: #00aaff;
        /* Изменяем цвет фона */
        color: white;
        /* Изменяем цвет текста */
        font-weight: bold;
        text-transform: uppercase;
    }

    .contract-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .section-center {
        display: block;
        /* Отменяем центровку */
        padding: 20px;
        /* Добавляем отступ для удобства чтения */
    }

    .add-contract-button {
        width: 50px;
        height: 50px;
        background-color: #00aaff;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
    }

    /* Стили для всплывающего окна */
    .modal {
        display: none;
        /* Скрываем модальное окно по умолчанию */
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        position: relative;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .modal-content h2 {
        margin-top: 0;
        color: #00aaff;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group.flex {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .form-item {
        flex: 1;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group input[type="tel"],
    .form-group select {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }

    .form-group select {
        background-color: #f9f9f9;
        cursor: pointer;
        appearance: none;
        /* Убираем стандартное оформление селектора */
        -webkit-appearance: none;
        /* Для WebKit браузеров */
        -moz-appearance: none;
        /* Для Firefox */
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 144"><path fill="%23333" d="M43.018 96.5l55.512-55.512a6.997 6.997 0 0 0-9.9-9.9L33.118 86.6a7.002 7.002 0 0 0 0 9.9l55.512 55.512a6.997 6.997 0 1 0 9.9-9.9L43.018 96.5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px;
        padding-right: 30px;
        /* Добавляем отступ справа для иконки */
    }

    .form-group input[type="submit"] {
        background-color: #00aaff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }

    .form-group input[type="submit"]:hover {
        background-color: #0088cc;
    }

    .edit-button,
    .delete-button {
        background-color: #00aaff;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        margin: 2px;
    }

    .edit-button:hover,
    .delete-button:hover {
        background-color: #0088cc;
    }

    .password-strength-indicator {
        display: flex;
        align-items: center;
        margin-top: 5px;
    }

    .strength-bar {
        width: 20px;
        height: 5px;
        background-color: #ddd;
        margin-right: 2px;
        border-radius: 3px;
    }

    .strength-bar.active {
        background-color: #00aaff;
    }
</style>

<script>
    function clearFormFields() {
        document.getElementById('contract-code').value = '';
        document.getElementById('object-name').value = '';
        document.getElementById('customer').value = '';
        document.getElementById('executer').value = '';
        document.getElementById('contract-number').value = '';
        document.getElementById('status').value = '';
        document.getElementById('stage').value = '';
        document.getElementById('contract-scan').value = '';
        document.getElementById('original-scan').value = '';
        document.getElementById('percent-complite').value = '';
        document.getElementById('date-start').value = '';
        document.getElementById('date-finish').value = '';
        document.getElementById('cost').value = '';
        document.getElementById('money-received').value = '';
        document.getElementById('money-left').value = '';
        document.getElementById('scan-complited-act').value = '';
        document.getElementById('original-complited-act').value = '';
        document.getElementById('volumes').value = '';
        document.getElementById('notes').value = '';
    }

    document.getElementById('add-contract-button').addEventListener('click', function () {
        clearFormFields();
        document.getElementById('add-contract-modal').style.display = 'block';
    });

    document.getElementById('close-modal').addEventListener('click', function () {
        document.getElementById('add-contract-modal').style.display = 'none';
    });

    document.getElementById('close-edit-modal').addEventListener('click', function () {
        document.getElementById('edit-contract-modal').style.display = 'none';
    });

    window.addEventListener('click', function (event) {
        var modal = document.getElementById('add-contract-modal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }

        var editModal = document.getElementById('edit-contract-modal');
        if (event.target == editModal) {
            editModal.style.display = 'none';
        }
    });

    document.querySelectorAll('.edit-button').forEach(button => {
        button.addEventListener('click', function () {
            const contractId = this.getAttribute('data-contract-id');
            fetch(`/contracts/${contractId}/`)
                .then(response => response.json())
                .then(contract => {
                    if (contract.detail) {
                        alert(contract.detail);
                        return;
                    }
                    document.getElementById('edit-contract-id').value = contract.id;
                    document.getElementById('edit-contract-code').value = contract.contract_code;
                    document.getElementById('edit-object-name').value = contract.object_name;
                    document.getElementById('edit-customer').value = contract.customer;
                    document.getElementById('edit-executer').value = contract.executer;
                    document.getElementById('edit-contract-number').value = contract.contract_number;
                    document.getElementById('edit-status').value = contract.status;
                    document.getElementById('edit-stage').value = contract.stage;
                    document.getElementById('edit-contract-scan').value = contract.contract_scan;
                    document.getElementById('edit-original-scan').value = contract.original_scan;
                    document.getElementById('edit-percent-complite').value = contract.percent_complite;
                    document.getElementById('edit-date-start').value = contract.date_start;
                    document.getElementById('edit-date-finish').value = contract.date_finish;
                    document.getElementById('edit-cost').value = contract.cost;
                    document.getElementById('edit-money-received').value = contract.money_received;
                    document.getElementById('edit-money-left').value = contract.money_left;
                    document.getElementById('edit-scan-complited-act').value = contract.scan_complited_act;
                    document.getElementById('edit-original-complited-act').value = contract.original_complited_act;
                    document.getElementById('edit-volumes').value = contract.volumes;
                    document.getElementById('edit-notes').value = contract.notes;
                    document.getElementById('edit-contract-modal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching contract data:', error);
                    alert(`Ошибка: ${error.message}`)
                });
        });
    });

    document.getElementById('edit-contract-form').addEventListener('submit', function (event) {
        event.preventDefault();
        const contractId = document.getElementById('edit-contract-id').value;
        const formData = new FormData(this);
        fetch(`/contracts/${contractId}/edit/`, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
        }).catch(error => {
            console.error('Error:', error);
            alert(`Ошибка: ${error.message}`);
        });
    });

    document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function () {
            const contractId = this.getAttribute('data-contract-id');
            if (confirm('Вы уверены, что хотите удалить этот договор?')) {
                fetch(`/contracts/${contractId}/delete/`, {
                    method: 'POST',
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Ошибка при удалении договора');
                    }
                });
            }
        });
    });
</script>
{% endblock %}